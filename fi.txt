version: '3'

services:
  gitlab-runner:
    image: gitlab/gitlab-runner:latest
    container_name: runner-docker
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./config:/etc/gitlab-runner
    environment:
      - REGISTRATION_TOKEN=TOKEN
      - CI_SERVER_URL=https://187.100.254.233:8888/
      - CLONE_URL=https://187.100.254.233:8888/
      - RUNNER_EXECUTOR=docker
      - DOCKER_IMAGE=docker:latest
      - DOCKER_PRIVILEGED=true
    entrypoint: >
      /bin/bash -c "
      if [ ! -f /etc/gitlab-runner/config.toml ]; then
        gitlab-runner register --non-interactive
          --url \$CI_SERVER_URL
          --registration-token \$REGISTRATION_TOKEN
          --clone-url \$CLONE_URL
          --executor \$RUNNER_EXECUTOR
          --docker-image \$DOCKER_IMAGE
          --docker-privileged;
      fi;
      gitlab-runner run
      "
